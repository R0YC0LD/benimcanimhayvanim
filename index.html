<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Farm Sim (Vanilla JS)</title>
    <style>
        /* CSS Reset & Temel Ayarlar */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #2c3e50; font-family: 'Segoe UI', sans-serif; }
        
        /* Oyun Sahnesi */
        #gameCanvas { display: block; width: 100%; height: 100%; touch-action: none; }

        /* KullanÄ±cÄ± ArayÃ¼zÃ¼ (HUD) Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Ãœst Bilgi Paneli */
        .hud-panel {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            padding: 10px; background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-weight: bold; color: #333; pointer-events: auto;
        }

        /* Context Menu (Tarlaya tÄ±klayÄ±nca aÃ§Ä±lan menÃ¼) */
        #context-menu {
            position: absolute; display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50px; padding: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            pointer-events: auto; transform: translate(-50%, -100%);
            z-index: 100; flex-direction: row; gap: 10px;
        }

        /* AraÃ§ Ä°konlarÄ± */
        .tool-icon {
            width: 60px; height: 60px; background: #fff; border: 2px solid #ddd;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; transition: transform 0.1s;
        }
        .tool-icon:active { transform: scale(0.9); background: #eee; }
        
        /* Bildirimler (Toast) */
        .toast {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 20px; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-panel">
            <div id="level-display">Lvl: 1</div>
            <div id="xp-display">XP: 0/100</div>
            <div id="coin-display">ðŸ’° 500</div>
            <div id="silo-display">Depo: 0/20</div>
        </div>
        
        <div id="context-menu"></div>
        
        <div id="toast-msg" class="toast">Mesaj</div>
    </div>

<script>
/**
 * PART 1: CONFIGURATION & DATABASE
 */

// Oyun Sabitleri
const TILE_SIZE = 80;
const GRID_ROWS = 6;
const GRID_COLS = 6;
const SAVE_KEY = 'FarmSim_SaveData_v1';

// CropManager: Ekin VeritabanÄ±
const CropManager = {
    WHEAT: { id: 'wheat', name: 'BuÄŸday', emoji: 'ðŸŒ¾', growTime: 5000, sellPrice: 5, seedCost: 1, xp: 2 }, // 5 sn
    CORN:  { id: 'corn',  name: 'MÄ±sÄ±r',  emoji: 'ðŸŒ½', growTime: 10000, sellPrice: 12, seedCost: 3, xp: 4 }, // 10 sn
    CARROT:{ id: 'carrot',name: 'HavuÃ§',  emoji: 'ðŸ¥•', growTime: 20000, sellPrice: 25, seedCost: 7, xp: 8 }, // 20 sn
    
    // YardÄ±mcÄ±: ID'den veriyi Ã§ekme
    getData: function(id) {
        return Object.values(this).find(c => c.id === id);
    }
};

// Tool Tipleri (Orak veya Tohumlar)
const ToolType = {
    HARVEST: 'harvest',
    PLANT: 'plant'
};
</script><script>
/**
 * PART 2: CORE SYSTEMS
 */

// --- SAVE SYSTEM ---
class SaveSystem {
    static load() {
        try {
            const data = localStorage.getItem(SAVE_KEY);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error("Save yÃ¼kleme hatasÄ±:", e);
            return null;
        }
    }

    static save(gameState) {
        try {
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
            console.log("Oyun otomatik kaydedildi.");
        } catch (e) {
            console.error("KayÄ±t hatasÄ±:", e);
        }
    }
}

// --- TILE CLASS (HÃ¼cre MantÄ±ÄŸÄ±) ---
class Tile {
    constructor(row, col) {
        this.row = row;
        this.col = col;
        this.state = 'empty'; // empty, plowed, planted
        this.cropId = null;
        this.plantedAt = 0;
        this.isVisualHighlight = false; // Drag efekti iÃ§in
    }

    // Ekin durumu kontrolÃ¼
    update() {
        // Sadece veri tutar, gÃ¶rselleÅŸtirme GridSystem'de yapÄ±lÄ±r
    }

    // BÃ¼yÃ¼me oranÄ±nÄ± hesapla (0.0 ile 1.0 arasÄ±)
    getGrowthProgress() {
        if (this.state !== 'planted' || !this.cropId) return 0;
        const crop = CropManager.getData(this.cropId);
        const elapsed = Date.now() - this.plantedAt;
        return Math.min(elapsed / crop.growTime, 1.0);
    }

    isReady() {
        return this.getGrowthProgress() >= 1.0;
    }
}

// --- INPUT MANAGER (Mobile & Desktop Normalization) ---
class InputManager {
    constructor(canvas, gameEngine) {
        this.canvas = canvas;
        this.engine = gameEngine;
        this.isDragging = false;
        this.activeTool = null; // { type: 'plant', cropId: 'wheat' } veya { type: 'harvest' }
        
        this.lastX = 0;
        this.lastY = 0;

        // Event Listeners
        this.bindEvents();
    }

    bindEvents() {
        // Mouse
        window.addEventListener('mousedown', (e) => this.start(e.clientX, e.clientY));
        window.addEventListener('mousemove', (e) => this.move(e.clientX, e.clientY));
        window.addEventListener('mouseup', () => this.end());

        // Touch
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Scroll engelle
            this.start(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.move(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });

        this.canvas.addEventListener('touchend', () => this.end());
    }

    start(x, y) {
        // UI etkileÅŸimi mi yoksa Canvas mÄ±?
        // Drag sadece Tool seÃ§ildiyse baÅŸlar (UIManager handle edecek)
        // Burada genel input takibi yapÄ±yoruz.
        this.lastX = x;
        this.lastY = y;
        
        // Raycast ile hangi tile?
        const tile = this.engine.gridSystem.getTileAtScreenPos(x, y);
        
        // EÄŸer bir tool aktif deÄŸilse ve tile'a tÄ±klandÄ±ysa menÃ¼ aÃ§
        if (!this.engine.uiManager.isToolActive) {
            if (tile) {
                this.engine.uiManager.showContextMenu(tile, x, y);
            } else {
                this.engine.uiManager.hideContextMenu();
            }
        }
    }

    move(x, y) {
        this.lastX = x;
        this.lastY = y;

        // TOOL DRAG MECHANIC
        if (this.engine.uiManager.isToolActive) {
            this.isDragging = true;
            
            // Raycast - ParmaÄŸÄ±n altÄ±ndaki tarlayÄ± bul
            const tile = this.engine.gridSystem.getTileAtScreenPos(x, y);
            
            if (tile) {
                // TarlayÄ± vurgula
                this.engine.gridSystem.highlightTile(tile);
                // Aksiyon uygula
                this.engine.gridSystem.applyToolAction(tile, this.engine.uiManager.activeTool);
            }
        }
    }

    end() {
        this.isDragging = false;
        // Tool drag bittiyse tool'u bÄ±rak
        if (this.engine.uiManager.isToolActive) {
            this.engine.uiManager.deactivateTool();
            this.engine.gridSystem.clearHighlights();
        }
    }
}

// --- GRID SYSTEM ---
class GridSystem {
    constructor(gameEngine) {
        this.engine = gameEngine;
        this.tiles = [];
        this.offsetX = 0;
        this.offsetY = 0;
        
        // Grid'i baÅŸlat veya yÃ¼kle
        this.initGrid();
    }

    initGrid() {
        // KayÄ±tlÄ± veri varsa oradan, yoksa sÄ±fÄ±rdan
        const savedData = this.engine.saveData ? this.engine.saveData.tiles : null;

        for (let r = 0; r < GRID_ROWS; r++) {
            this.tiles[r] = [];
            for (let c = 0; c < GRID_COLS; c++) {
                const tile = new Tile(r, c);
                // KayÄ±t varsa veriyi iÅŸle
                if (savedData && savedData[r] && savedData[r][c]) {
                    Object.assign(tile, savedData[r][c]);
                }
                this.tiles[r][c] = tile;
            }
        }
        this.centerGrid();
    }

    centerGrid() {
        // Grid'i ekranÄ±n ortasÄ±na yerleÅŸtir
        const gridWidth = GRID_COLS * TILE_SIZE;
        const gridHeight = GRID_ROWS * TILE_SIZE;
        this.offsetX = (this.engine.canvas.width / this.engine.dpr - gridWidth) / 2;
        this.offsetY = (this.engine.canvas.height / this.engine.dpr - gridHeight) / 2;
    }

    // Ekran koordinatÄ±nÄ± (x,y) Grid (r,c) Ã§evirir
    getTileAtScreenPos(x, y) {
        // Canvas scale edildiÄŸi iÃ§in inputu DPR'a bÃ¶lmek gerekmez (BoundingRect kullanÄ±lÄ±rsa gerekir)
        // Ancak burada input direkt clientX geliyor, canvas style size ile eÅŸleÅŸmeli.
        // Basitlik iÃ§in:
        
        const adjX = x - this.offsetX;
        const adjY = y - this.offsetY;

        const col = Math.floor(adjX / TILE_SIZE);
        const row = Math.floor(adjY / TILE_SIZE);

        if (row >= 0 && row < GRID_ROWS && col >= 0 && col < GRID_COLS) {
            return this.tiles[row][col];
        }
        return null;
    }

    applyToolAction(tile, tool) {
        // Hasat Ä°ÅŸlemi
        if (tool.type === ToolType.HARVEST) {
            if (tile.state === 'planted' && tile.isReady()) {
                const crop = CropManager.getData(tile.cropId);
                
                // Depo KontrolÃ¼
                if (this.engine.inventoryCount >= this.engine.maxSilo) {
                    this.engine.uiManager.showToast("Depo Dolu!");
                    return;
                }

                // Hasat BaÅŸarÄ±lÄ±
                tile.state = 'empty';
                tile.cropId = null;
                this.engine.addReward(crop.xp, crop.sellPrice); // Direkt satÄ±lÄ±yor gibi simÃ¼le ettim basitlik iÃ§in
                this.engine.inventoryCount++;
                this.engine.playSound('pop'); // (Ses placeholder)
            }
        }
        
        // Ekim Ä°ÅŸlemi
        else if (tool.type === ToolType.PLANT) {
            if (tile.state === 'empty') {
                const crop = CropManager.getData(tool.cropId);
                
                // Para KontrolÃ¼
                if (this.engine.gold >= crop.seedCost) {
                    this.engine.gold -= crop.seedCost;
                    tile.state = 'planted';
                    tile.cropId = crop.id;
                    tile.plantedAt = Date.now();
                    this.engine.uiManager.updateHUD();
                } else {
                    this.engine.uiManager.showToast("Yetersiz AltÄ±n!");
                }
            }
        }
    }

    highlightTile(targetTile) {
        this.clearHighlights();
        targetTile.isVisualHighlight = true;
    }

    clearHighlights() {
        for(let r=0; r<GRID_ROWS; r++) {
            for(let c=0; c<GRID_COLS; c++) {
                this.tiles[r][c].isVisualHighlight = false;
            }
        }
    }

    draw(ctx) {
        for (let r = 0; r < GRID_ROWS; r++) {
            for (let c = 0; c < GRID_COLS; c++) {
                const tile = this.tiles[r][c];
                const x = c * TILE_SIZE + this.offsetX;
                const y = r * TILE_SIZE + this.offsetY;

                // 1. Zemin (Toprak)
                ctx.fillStyle = tile.state === 'empty' ? '#8d6e63' : '#5d4037'; // AÃ§Ä±k/Koyu kahve
                
                // Highlight efekti
                if (tile.isVisualHighlight) ctx.fillStyle = '#a1887f';

                ctx.fillRect(x + 1, y + 1, TILE_SIZE - 2, TILE_SIZE - 2); // Marginli Ã§izim

                // Border (Hafif 3D)
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);

                // 2. Ekin Ã‡izimi
                if (tile.state === 'planted') {
                    const progress = tile.getGrowthProgress();
                    const crop = CropManager.getData(tile.cropId);
                    
                    // BÃ¼yÃ¼me animasyonu (Scale)
                    const size = 20 + (progress * 40); // 20px den 60px'e
                    const opacity = 0.5 + (progress * 0.5);

                    ctx.font = `${size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // EÄŸer hazÄ±rsa zÄ±plama efekti (basit Math.sin)
                    let bounceY = 0;
                    if (progress >= 1.0) {
                         bounceY = Math.sin(Date.now() / 200) * 5;
                    }

                    ctx.globalAlpha = opacity;
                    ctx.fillText(crop.emoji, x + TILE_SIZE/2, y + TILE_SIZE/2 + bounceY);
                    ctx.globalAlpha = 1.0;

                    // Progress Bar (HenÃ¼z bÃ¼yÃ¼mediyse)
                    if (progress < 1.0) {
                        ctx.fillStyle = '#444';
                        ctx.fillRect(x + 10, y + TILE_SIZE - 15, TILE_SIZE - 20, 5);
                        ctx.fillStyle = '#76ff03';
                        ctx.fillRect(x + 10, y + TILE_SIZE - 15, (TILE_SIZE - 20) * progress, 5);
                    }
                }
            }
        }
    }
}
</script><script>
/**
 * PART 3: GAME ENGINE & UI
 */

// --- UI MANAGER ---
class UIManager {
    constructor(gameEngine) {
        this.engine = gameEngine;
        this.menu = document.getElementById('context-menu');
        this.isToolActive = false;
        this.activeTool = null;
        
        // Element ReferanslarÄ±
        this.hudLevel = document.getElementById('level-display');
        this.hudXP = document.getElementById('xp-display');
        this.hudCoin = document.getElementById('coin-display');
        this.hudSilo = document.getElementById('silo-display');
    }

    updateHUD() {
        this.hudLevel.innerText = `Lvl: ${this.engine.level}`;
        this.hudXP.innerText = `XP: ${this.engine.xp}`;
        this.hudCoin.innerText = `ðŸ’° ${this.engine.gold}`;
        this.hudSilo.innerText = `Depo: ${this.engine.inventoryCount}/${this.engine.maxSilo}`;
    }

    showToast(msg) {
        const toast = document.getElementById('toast-msg');
        toast.innerText = msg;
        toast.style.opacity = 1;
        setTimeout(() => toast.style.opacity = 0, 2000);
    }

    showContextMenu(tile, screenX, screenY) {
        // MenÃ¼ pozisyonu
        this.menu.style.left = `${screenX}px`;
        this.menu.style.top = `${screenY - 20}px`;
        this.menu.style.display = 'flex';
        this.menu.innerHTML = ''; // Temizle

        // Ä°Ã§eriÄŸi duruma gÃ¶re doldur
        // 1. ORAK (Hasat)
        if (tile.state === 'planted' && tile.isReady()) {
            const btn = this.createToolBtn('ðŸ—¡ï¸', { type: ToolType.HARVEST });
            this.menu.appendChild(btn);
        }
        
        // 2. TOHUMLAR (Ekim)
        else if (tile.state === 'empty') {
            [CropManager.WHEAT, CropManager.CORN, CropManager.CARROT].forEach(crop => {
                const btn = this.createToolBtn(crop.emoji, { type: ToolType.PLANT, cropId: crop.id });
                this.menu.appendChild(btn);
            });
        } 
        
        // HiÃ§bir ÅŸey yoksa menÃ¼yÃ¼ gizle
        if (this.menu.children.length === 0) {
            this.menu.style.display = 'none';
        }
    }

    createToolBtn(emoji, toolData) {
        const div = document.createElement('div');
        div.className = 'tool-icon';
        div.innerText = emoji;
        
        // TOUCH START - SÃ¼rÃ¼kleme BaÅŸlangÄ±cÄ±
        div.addEventListener('touchstart', (e) => {
            e.preventDefault(); // MenÃ¼nÃ¼n kapanmasÄ±nÄ± engelle
            this.activateTool(toolData);
            this.menu.style.display = 'none'; // MenÃ¼yÃ¼ gizle ki altÄ±nÄ± gÃ¶relim
        }, { passive: false });
        
        // Mouse iÃ§in de destek (Test amaÃ§lÄ±)
        div.addEventListener('mousedown', (e) => {
            e.preventDefault();
            this.activateTool(toolData);
            this.menu.style.display = 'none';
        });

        return div;
    }

    hideContextMenu() {
        this.menu.style.display = 'none';
    }

    activateTool(toolData) {
        this.isToolActive = true;
        this.activeTool = toolData;
        console.log("Tool SeÃ§ildi:", toolData);
        // Ä°steÄŸe baÄŸlÄ±: Ekranda seÃ§ili tool imleci gÃ¶sterilebilir
    }

    deactivateTool() {
        this.isToolActive = false;
        this.activeTool = null;
    }
}

// --- MAIN GAME ENGINE ---
class GameEngine {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // Veri YÃ¼kleme
        this.saveData = SaveSystem.load();
        
        // Ekonomi ve Ä°statistikler
        this.gold = this.saveData ? this.saveData.gold : 500;
        this.xp = this.saveData ? this.saveData.xp : 0;
        this.level = this.saveData ? this.saveData.level : 1;
        this.inventoryCount = this.saveData ? this.saveData.inventoryCount : 0;
        this.maxSilo = 20;

        // High DPI AyarÄ±
        this.dpr = window.devicePixelRatio || 1;
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // Alt Sistemler
        this.gridSystem = new GridSystem(this);
        this.uiManager = new UIManager(this);
        this.inputManager = new InputManager(this.canvas, this);
        
        this.lastTime = 0;
        
        // Auto-Save DÃ¶ngÃ¼sÃ¼ (Her 10 saniyede bir)
        setInterval(() => this.saveGame(), 10000);

        // Ä°lk UI gÃ¼ncellemesi
        this.uiManager.updateHUD();

        // DÃ¶ngÃ¼yÃ¼ baÅŸlat
        requestAnimationFrame((t) => this.loop(t));
    }

    resize() {
        this.canvas.width = window.innerWidth * this.dpr;
        this.canvas.height = window.innerHeight * this.dpr;
        this.ctx.scale(this.dpr, this.dpr);
        if (this.gridSystem) this.gridSystem.centerGrid();
    }

    saveGame() {
        const state = {
            gold: this.gold,
            xp: this.xp,
            level: this.level,
            inventoryCount: this.inventoryCount,
            tiles: this.gridSystem.tiles // Tile nesneleri JSON'a serialize olur
        };
        SaveSystem.save(state);
    }

    addReward(xp, gold) {
        this.xp += xp;
        this.gold += gold;
        this.uiManager.updateHUD();
        // Basit Level mantÄ±ÄŸÄ±
        if (this.xp > this.level * 100) {
            this.level++;
            this.uiManager.showToast(`SEVÄ°YE ATLADIN! Lvl ${this.level}`);
        }
    }

    playSound(type) {
        // AudioContext veya basit HTML5 Audio eklenebilir.
        // TarayÄ±cÄ± kÄ±sÄ±tlamalarÄ± nedeniyle boÅŸ bÄ±rakÄ±ldÄ±.
    }

    loop(timestamp) {
        const dt = timestamp - this.lastTime;
        this.lastTime = timestamp;

        // 1. UPDATE
        // Animasyonlar vs. burada gÃ¼ncellenebilir

        // 2. RENDER
        // EkranÄ± temizle (Ã‡im rengi)
        this.ctx.fillStyle = '#81c784'; 
        this.ctx.fillRect(0, 0, this.canvas.width / this.dpr, this.canvas.height / this.dpr);

        // IzgarayÄ± Ã§iz
        this.gridSystem.draw(this.ctx);

        requestAnimationFrame((t) => this.loop(t));
    }
}

// Oyunu BaÅŸlat
window.onload = () => {
    const game = new GameEngine();
};

</script>
</body>
</html>
